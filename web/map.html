<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte Interactif avec Leaflet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .leaflet-popup-content {
            width: 200px;
        }
        /* Style pour le SVG utilisé comme icône de marqueur */
        .svg-marker-icon {
            width: 30px;
            height: 40px;
            fill: #d96728;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var map;
        function initMap() {
            // Création de la carte sans le contrôle de zoom par défaut
            map = L.map('map', {
                dragging: true,
                scrollWheelZoom: false,
                zoomControl: false
            }).setView([45.9575298, 5.3356586], 8);

            // Ajout de la couche de tuiles
            var osmUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            var osmAttrib = 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
            var osm = new L.TileLayer(osmUrl, {minZoom: 3, maxZoom: 18, attribution: osmAttrib});
            map.addLayer(osm);

            // Ajout du contrôle de zoom après avoir créé la carte
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Fonction pour ajouter des marqueurs à la carte
            buildCoordsWithJSON();
        }

        function buildCoordsWithJSON() {
            var url = 'proxy.php'; // Utilisation du fichier proxy pour les requêtes AJAX
            $.get(url, function(data) {
                // Supposons que `data` est une liste d'objets avec des données de marqueur
                data.forEach(function(item) {
                    var customIcon = L.divIcon({
                        className: "svg-marker-icon",
                        html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/></svg>',
                        iconSize: [30, 40],
                        iconAnchor: [15, 40]
                    });
                    var marker = L.marker([item.field_map_lat, item.field_map_lng], {icon: customIcon}).addTo(map);
                    marker.bindPopup(
                        `<strong>${item.title}</strong><br>` +
                        `${item.description}<br>` +
                        `<a href="${item.url}" target="_blank">Plus d'info</a><br>` +
                        `<em>${item.field_address_address_line1}, ${item.field_address_locality}</em><br>` +
                        `<strong>Contact:</strong> ${item.phone}<br>` +
                        `<strong>Services:</strong> ${item.service}`
                    );
                });
            }).fail(function() {
                console.error("Failed to fetch data");
            });
        }

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
